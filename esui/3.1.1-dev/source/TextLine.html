<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='global-property-'>/**
</span> * ESUI (Enterprise Simple UI)
 * Copyright 2013 Baidu Inc. All rights reserved.
 * 
 * @ignore
 * @file 多行带行码输入框
 * @author dbear, otakustay
 */

define(
    function (require) {
        var u = require(&#39;underscore&#39;);
        var lib = require(&#39;./lib&#39;);
        var InputControl = require(&#39;./InputControl&#39;);
        var ui = require(&#39;./main&#39;);

        require(&#39;./TextBox&#39;);

<span id='TextLine-method-constructor'><span id='TextLine'>        /**
</span></span>         * 带行号的输入框
         *
         * @extends InputControl
         * @requires TextBox
         * @constructor
         */
        function TextLine(options) {
            InputControl.apply(this, arguments);
        }

<span id='global-method-getMainHTML'>        /**
</span>         * 获取主体的HTML
         *
         * @param {TextLine} textLine 控件实例
         * @ignore
         */
        function getMainHTML(textLine) {
            var html = [
                textLine.helper.getPartBeginTag(&#39;num-line&#39;, &#39;div&#39;),
                    &#39;1&#39;, // 默认至少有一行
                textLine.helper.getPartEndTag(&#39;num-line&#39;, &#39;div&#39;),
                textLine.helper.getPartBeginTag(&#39;text-container&#39;, &#39;div&#39;),
                    textLine.helper.getPartHTML(&#39;text&#39;, &#39;textarea&#39;),
                textLine.helper.getPartEndTag(&#39;text-container&#39;, &#39;div&#39;)
            ];

            return html.join(&#39;&#39;);
        }

<span id='global-method-refreshOnInput'>        /**
</span>         * 输入时刷新其它部件
         *
         * @param {Event} e DOM事件对象
         * @ignore
         */
        function refreshOnInput(e) {
            if (e.type === &#39;input&#39; || e.propertyName === &#39;value&#39;) {
                refreshLineNum.call(this);
            }
        }


<span id='global-method-refreshLineNum'>        /**
</span>         * 重置行号，增加内容和`keyup`时可调用
         *
         * @ignore
         */
        function refreshLineNum() {
            var num = this.helper.getPart(&#39;text&#39;).value.split(&#39;\n&#39;).length;
            if (num !== this.number) {
                this.number = num;
                var numLine = this.helper.getPart(&#39;num-line&#39;);
                numLine.innerHTML = u.range(1, num + 1).join(&#39;&lt;br /&gt;&#39;);
            }
            this.resetScroll();
<span id='TextLine-event-change'>            /**
</span>             * @event change
             *
             * 当值变化时触发
             *
             * @member TextLine
             */
            this.fire(&#39;change&#39;);
        }


        TextLine.prototype = {
<span id='TextLine-property-type'>            /**
</span>             * 控件类型，始终为`&quot;TextLine&quot;`
             * 
             * @type {string}
             * @readonly
             * @override
             */
            type: &#39;TextLine&#39;,

<span id='TextLine-method-initOptions'>            /**
</span>             * 初始化参数
             *
             * @param {Object} [options] 构造函数传入的参数
             * @protected
             * @override
             */
            initOptions: function (options) {
                // 默认选项配置
                var properties = {
                    width: 300,
                    height: 200,
                    value: &#39;&#39;
                };
                if (lib.isInput(this.main)) {
                    this.helper.extractOptionsFromInput(this.main, properties);
                }
                u.extend(properties, options);

                if (!properties.hasOwnProperty(&#39;title&#39;) &amp;&amp; this.main.title) {
                    properties.title = this.main.title;
                }
                
                this.setProperties(properties);
            },

<span id='TextLine-method-initStructure'>            /**
</span>             * 初始化DOM结构
             *
             * @protected
             * @override
             */
            initStructure: function () {
                // 如果主元素是输入元素，替换成`&lt;div&gt;`
                // 如果输入了非块级元素，则不负责
                if (lib.isInput(this.main)) {
                    this.helper.replaceMain();
                }
                
                this.main.innerHTML = getMainHTML(this);
                // 创建控件树
                this.helper.initChildren();

                // 输入区变化监听
                var textArea = this.helper.getPart(&#39;text&#39;);
                var inputEvent = (&#39;oninput&#39; in textArea) 
                    ? &#39;input&#39; 
                    : &#39;propertychange&#39;;
                this.helper.addDOMEvent(textArea, inputEvent, refreshOnInput);
                this.helper.addDOMEvent(textArea, &#39;scroll&#39;, this.resetScroll);
            },

<span id='TextLine-method-repaint'>            /**
</span>             * 重新渲染
             *
             * @method
             * @protected
             * @override
             */
            repaint: require(&#39;./painters&#39;).createRepaint(
                InputControl.prototype.repaint,
                {
<span id='TextLine-property-height'>                    /**
</span>                     * @property {number} height
                     *
                     * 控件的高度
                     */
                    name: &#39;height&#39;,
                    paint: function (textLine, height) {
                        height = height || 300;

                        // 渲染行号区高度
                        var lineNumDiv = textLine.helper.getPart(&#39;num-line&#39;);
                        lineNumDiv.style.height = height + &#39;px&#39;;
                        
                        // 主体高度
                        textLine.main.style.height = height + &#39;px&#39;;
                    }
                },
                {
<span id='TextLine-property-width'>                    /**
</span>                     * @property {number} width
                     *
                     * 控件的宽度
                     */
                    name: &#39;width&#39;,
                    paint: function (textLine, width) {
                        width = width || 300;
                        
                        // 主体高度
                        textLine.main.style.width = width + &#39;px&#39;;
                    }
                },
                {
<span id='TextLine-property-rawValue'>                    /**
</span>                     * @property {string[]} rawValue
                     *
                     * 控件的原始值，为字符串数组，每行表示一个字符串
                     *
                     * @override
                     */
                    name: &#39;rawValue&#39;,
                    paint: function (textLine, value) {
                        // 输入区
                        var textArea = textLine.helper.getPart(&#39;text&#39;);

                        if (value) {
                            if (u.isArray(value)) {
                                textLine.value = u.unescape(value.join(&#39;\n&#39;));
                            }
                            // 好怕怕有一个人直接设置了字符串
                            else if (typeof value === &#39;string&#39;) {
                                textLine.value = u.unescape(value);
                            }

                            var inputEvent = &#39;oninput&#39; in textArea
                                ? &#39;input&#39;
                                : &#39;propertychange&#39;;
                            textLine.helper.removeDOMEvent(
                                textArea, inputEvent, refreshOnInput);
                            textArea.value = textLine.value;
                            textLine.helper.addDOMEvent(
                                textArea, inputEvent, refreshOnInput);

                            refreshLineNum.call(textLine);
                        }
                    }
                }, 
                {
                    name: [&#39;disabled&#39;, &#39;readOnly&#39;],
                    paint: function (textLine, disabled, readOnly) {
                        var textArea = textLine.helper.getPart(&#39;text&#39;);
                        textArea.disabled = !!disabled;
                        textArea.readOnly = !!readOnly;
                    }
                }
            ),

<span id='TextLine-method-resetScroll'>            /**
</span>             * 滚动文本输入框
             */
            resetScroll: function () {
                var textArea = this.helper.getPart(&#39;text&#39;);
                var lineNumber = this.helper.getPart(&#39;num-line&#39;);
                // 因为可能产生滚动条，所以要同步一下行码区和文字区的高度
                lineNumber.style.height = textArea.clientHeight + &#39;px&#39;;
                lineNumber.scrollTop = textArea.scrollTop;
            },

<span id='TextLine-method-stringifyValue'>            /**
</span>             * 将值从原始格式转换成字符串
             * 
             * @param {string[]} rawValue 原始值
             * @return {string}
             * @protected
             * @override
             */
            stringifyValue: function (rawValue) {
                return rawValue.join(&#39;\n&#39;);
            },

<span id='TextLine-method-parseValue'>            /**
</span>             * 将字符串类型的值转换成原始格式
             * 
             * @param {string} value 字符串值
             * @return {string[]}
             * @protected
             * @override
             */
            parseValue: function (value) {
                return lib.trim(value.replace(/\n{2,}/g, &#39;\n&#39;)).split(&#39;\n&#39;);
            },

<span id='TextLine-method-getRawValue'>            /**
</span>             * 获取内容数组形式（去重，去空行）
             *
             * @return {string[]}
             * @override
             */
            getRawValue: function() {
                return u.unique(this.getValueRepeatableItems());
            },

<span id='TextLine-method-getValueRepeatableItems'>            /**
</span>             * 获取内容数组形式,并去除空串内容（不去重）
             *
             * @return {string[]}
             */
            getValueRepeatableItems: function() {
                var text = this.helper.getPart(&#39;text&#39;).value;
                var items = text.split(&#39;\n&#39;);

                return u.chain(items).map(lib.trim).compact().value();
            },

<span id='TextLine-method-getRowsNumber'>            /**
</span>             * 获取内容行数
             *
             * @return {number}
             */
            getRowsNumber: function() {
               var items = this.getValue().split(&#39;\n&#39;);
               return items.length;
            },

<span id='TextLine-method-addLines'>            /**
</span>             * 增加内容
             *
             * @param {string[]} lines 需添加的行
             */
            addLines: function(lines) {
                var content = lines.join(&#39;\n&#39;);
                var value = this.getValue();
        
                if (value.length &gt; 0) {
                    content = value + &#39;\n&#39; + content;
                }
        
                this.setRawValue(content);
            }

        };

        lib.inherits(TextLine, InputControl);
        ui.register(TextLine);

        return TextLine;
    }
);
</pre>
</body>
</html>
