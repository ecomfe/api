<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='global-property-'>/**
</span> * ESUI (Enterprise Simple UI)
 * Copyright 2013 Baidu Inc. All rights reserved.
 *
 * @ignore
 * @file 翻页控件
 * @author shenbin
 */
define(
    function (require) {
        var u = require(&#39;underscore&#39;);
        var lib = require(&#39;./lib&#39;);
        var ui = require(&#39;./main&#39;);
        var Control = require(&#39;./Control&#39;);

        require(&#39;./Select&#39;);

<span id='global-method-getMainHTML'>        /**
</span>         * 获取控件主元素HTML
         *
         * @param {Pager} pager 控件实例
         * @return {string} 拼接得到的HTML代码
         * @ignore
         */
        function getMainHTML(pager) {
            var template = [
                &#39;&lt;div id=&quot;${pagerWrapperId}&quot; class=&quot;${pagerWrapperClass}&quot;&gt;&#39;,
                    &#39;&lt;div id=&quot;${selectWrapperId}&quot; &#39;,
                    &#39;class=&quot;${selectWrapperClass}&quot;&gt;&#39;,
                        &#39;&lt;span id=&quot;${labelId}&quot; class=&quot;${labelClass}&quot;&gt;&#39;,
                        &#39;${labelText}&lt;/span&gt;&#39;,
                        &#39;&lt;div data-ui=&quot;type:Select;childName:select;&#39;,
                        &#39;id:${selectId};width:40;&quot;&gt;&lt;/div&gt;&#39;,
                    &#39;&lt;/div&gt;&#39;,
                    &#39;&lt;ul id=&quot;${mainId}&quot; class=&quot;${mainClass}&quot;&gt;&lt;/ul&gt;&#39;,
                &#39;&lt;/div&gt;&#39;
            ];

            return lib.format(
                template.join(&#39;&#39;),
                {
                    pagerWrapperId: pager.helper.getId(&#39;pager-wrapper&#39;),
                    pagerWrapperClass:
                        pager.helper.getPartClasses(pager.layout)[0],
                    selectWrapperId: pager.helper.getId(&#39;select-wrapper&#39;),
                    selectWrapperClass:
                        pager.helper.getPartClassName(&#39;select-wrapper&#39;),
                    labelId: pager.helper.getId(&#39;label&#39;),
                    labelClass: pager.helper.getPartClassName(&#39;label&#39;),
                    labelText: &#39;每页显示&#39;,
                    selectId: pager.helper.getId(&#39;select&#39;),
                    mainId: pager.helper.getId(&#39;main&#39;),
                    mainClass: pager.helper.getPartClassName(&#39;main&#39;)
                }
            );
        }

<span id='global-method-getPagerMainHTML'>        /**
</span>         * 获取页码区域元素代码
         *
         * @param {Pager} pager Pager控件实例
         * @return {string} 拼接得到的HTML代码
         * @ignore
         */
        function getPagerMainHTML(pager) {
            // 定义页码模板
            var plainTpl = &#39;&lt;li class=&quot;${className}&quot; id=&quot;${id}&quot;&#39;
                + &#39; data-page=&quot;${page}&quot;&gt;${text}&lt;/li&gt;&#39;;
            var anchorTpl = &#39;&lt;li class=&quot;${className}&quot; id=&quot;${id}&quot;&gt;&#39;
                + &#39;&lt;a href=&quot;${link}&quot;&gt;${text}&lt;/a&gt;&lt;/li&gt;&#39;;
            var omitTpl = &#39;&lt;li class=&quot;${className}&quot;&gt;…&lt;/li&gt;&#39;;

<span id='global-method-getUrlByTemplate'>            /**
</span>             * 根据模板拼接url
             *
             * @param {number} num 页码
             * @return {string} 拼接返回的URL
             * @ignore
             */
            function getUrlByTemplate(num) {
                return lib.format(
                    pager.urlTemplate,
                    {
                        page: num,
                        pageSize: pager.pageSize
                    }
                );
            }

<span id='global-method-getTplObj'>            /**
</span>             * 生成用于填充模板的对象
             *
             * @param {string} className 类名
             * @param {number} [num] 页码
             * @param {number} [id] 用于模板的id字段
             * @param {string | number} [text] 用于模板的text字段
             * @return {Object} 用于填充模板的对象
             * @ignore
             */
            function getTplObj(className, num, id, text) {
                var obj = {
                    className: pager.helper.getPartClassName(className)
                };

                if (arguments.length &gt; 1) {
                    obj.link = getUrlByTemplate(num);
                    obj.id = pager.helper.getId(id);
                    obj.page = num;
                    obj.text = text;
                }

                return obj;
            }

<span id='global-method-getSegmentHTML'>            /**
</span>             * 根据模板和填充对象格式化生成页面片段代码
             *
             * @param {Object} obj 用于填充模板的对象
             * @param {string} [tpl] 页面片段模板
             * @return {string} 页面片段代码
             * @ignore
             */
            function getSegmentHTML(obj, tpl) {
                if (!tpl) {
                    var templates = {
                        anchor: anchorTpl,
                        plain: plainTpl
                    };

                    // 由于pageType需要由外部指定，当指定的模板不存在时默认匹配anchor
                    tpl = templates[pager.pageType] || templates.anchor;
                }

                return lib.format(tpl, obj);
            }

<span id='global-method-addSegmentToHTML'>            /**
</span>             * 将页面片段添加到html数组中
             *
             * @param {Object | number} obj Object或者page
             * @param {string} [tpl] 可选模板
             * @ignore
             */
            function addSegmentToHTML(obj, tpl) {
                if (typeof obj === &#39;number&#39;) {
                    obj = getTplObj(&#39;item&#39;, obj, &#39;page-&#39; + obj, obj);
                }
                var segment = getSegmentHTML(obj, tpl);

                html.push(segment);
            }

            var page = pager.page;
            var backCount = pager.backCount;
            var forwardCount = pager.forwardCount;
            // 计算得到的总页码数
            var totalPage = Math.ceil(pager.count / pager.pageSize);
            // 数组html用于存储页码区域的元素代码
            var html = [];

            // 上一页
            if (page &gt; 1) {
                var obj = getTplObj(
                    &#39;item-extend&#39;, page - 1, &#39;page-back&#39;, pager.backText);
                addSegmentToHTML(obj);
            }

            // 前缀页码
            if (page &gt; backCount + 1) {
                addSegmentToHTML(1);

                // 前缀...符号
                if (page &gt; backCount + 2) {
                    var obj = getTplObj(&#39;item-omit&#39;);
                    addSegmentToHTML(obj, omitTpl);
                }
            }

            /*
             * 中间页码区
             */
            // 前置页码
            var len = page &gt; backCount ? backCount : page - 1;
            for (var i = page - len; i &lt; page; i++) {
                addSegmentToHTML(i);
            }

            // 当前页码
            var obj = getTplObj(
                &#39;item-current&#39;,
                page,
                &#39;page-&#39; + page,
                page
            );
            addSegmentToHTML(obj, plainTpl);

            // 后置页码
            var len = totalPage - page &gt; forwardCount
                ? forwardCount
                : totalPage - page;
            for (var i = page + 1; i &lt; page + len + 1; i++) {
                addSegmentToHTML(i);
            }

            // 后缀页码
            if (page &lt; totalPage - forwardCount) {
                // 后缀...符号
                if (page &lt; totalPage - forwardCount - 1) {
                    var obj = getTplObj(&#39;item-omit&#39;);
                    addSegmentToHTML(obj, omitTpl);
                }

                addSegmentToHTML(totalPage);
            }

            // 下一页
            if (page &lt; totalPage) {
                var obj = getTplObj(
                    &#39;item-extend&#39;, page + 1, &#39;page-forward&#39;, pager.forwardText);
                addSegmentToHTML(obj);
            }

            return html.join(&#39;&#39;);
        }

<span id='global-method-repaintPager'>        /**
</span>         * 绘制页码区域部件
         *
         * @param {Pager} pager Pager控件实例
         * @ignore
         */
        function repaintPager(pager) {
            // 修正每页显示条数，每页显示不能为0
            var pageSize = pager.pageSize;
            pageSize = pageSize &gt; 0 ? pageSize : 1;
            pager.pageSize = pageSize;
            // 将修正后的每页显示数量更新至Select控件
            pager.getChild(&#39;select&#39;).set(&#39;value&#39;, pageSize + &#39;&#39;);

            // 修正页码
            var totalPage = Math.ceil(pager.count / pageSize);
            var page = pager.page;
            page = page &gt; totalPage ? totalPage : page;
            page = page &gt; 0 ? page : 1;
            pager.page = page;

            // 渲染main元素页面结构
            var pagerMain = pager.helper.getPart(&#39;main&#39;);
            pagerMain.innerHTML = getPagerMainHTML(pager);
        }

<span id='global-method-repaintLayout'>        /**
</span>         * 绘制控件布局结构
         *
         * @param {Pager} pager 控件实例
         * @param {string} style 布局样式
         * @ignore
         */
        function repaintLayout(pager, style) {
<span id='global-method-getClasses'>            /**
</span>             * 获取class的集合
             *
             * @param {string} [style] 布局类型
             * @return {string[]} 布局类型集合
             * @ignore
             */
            function getClasses() {
                var classes = [];
                for (var i = 0, len = arguments.length; i &lt; len; i++) {
                    classes.push(pager.helper.getPartClasses(arguments[i])[0]);
                }

                return classes;
            }

            var pagerWrapper = pager.helper.getPart(&#39;pager-wrapper&#39;);
            lib.removeClasses(
                pagerWrapper,
                getClasses(
                    &#39;alignLeft&#39;, &#39;alignLeftReversed&#39;,
                    &#39;alignRight&#39;, &#39;alignRightReversed&#39;,
                    &#39;distributed&#39;, &#39;distributedReversed&#39;
                )
            );
            lib.addClass(pagerWrapper, pager.helper.getPartClasses(style)[0]);
        }

<span id='global-method-pagerClick'>        /**
</span>         * 页码点击事件触发
         *
         * @param {Pager} this Pager控件实例
         * @param {Event} e 事件对象
         * @ignore
         */
        function pagerClick(e) {
            var target = e.target;
            var backId = this.helper.getId(&#39;page-back&#39;);
            var forwardId = this.helper.getId(&#39;page-forward&#39;);
            var page = this.page;

            if (this.helper.isPart(target, &#39;item&#39;)
                || this.helper.isPart(target, &#39;item-extend&#39;)
            ) {
                if (target.id === backId) {
                    page--;
                }
                else if (target.id === forwardId) {
                    page++;
                }
                else {
                    page = +lib.getAttribute(target, &#39;data-page&#39;);
                }

                // 跳转至某页码
                this.set(&#39;page&#39;, page);
            }
        }

<span id='global-method-getPageSizes'>        /**
</span>         * 获取select的下拉控件的数据
         *
         * @param {number[]} pageSizes 配置信息中的下拉数据
         * @return {meta.SelectItem[]} 用于`Select`控件的数据源对象
         * @ignore
         */
        function getPageSizes(pageSizes) {
            var datasource = u.map(
                pageSizes,
                function (size) {
                    return { text: size + &#39;&#39;, value: size + &#39;&#39; };
                }
            );

            return datasource;
        }

<span id='global-method-changePageSize'>        /**
</span>         * 更新`Select`控件的`value`属性
         *
         * @param {mini-event.Event} e 事件对象
         * @ignore
         */
        function changePageSize(e) {
            var pageSize = parseInt(this.getChild(&#39;select&#39;).getValue(), 10);
            this.pageSize = pageSize;

            // 重绘页码
            repaintPager(this);

            // 触发每页显示变更的事件
<span id='Pager-event-changepagesize'>            /**
</span>             * @event changepagesize
             *
             * 每页条数变化时触发
             *
             * @member Pager
             * @deprecated 使用{@link Pager#pagesizechange}代替
             */
            this.fire(&#39;changepagesize&#39;);

<span id='Pager-event-pagesizechange'>            /**
</span>             * @event pagesizechange
             *
             * 每页条数变化时触发
             *
             * @member Pager
             */
            this.fire(&#39;pagesizechange&#39;);
        }

<span id='global-method-showSelect'>        /**
</span>         * 显示`Select`控件及对应的label元素
         *
         * @param {Pager} pager 控件实例
         * @ignore
         */
        function showSelect(pager) {
            var selectWrapper = pager.helper.getPart(&#39;select-wrapper&#39;);
            pager.helper.removePartClasses(&#39;select-hidden&#39;, selectWrapper);
        }

<span id='global-method-hideSelect'>        /**
</span>         * 隐藏`Select`控件及对应的label元素
         *
         * @param {Pager} pager 控件实例
         * @ignore
         */
        function hideSelect(pager) {
            var selectWrapper = pager.helper.getPart(&#39;select-wrapper&#39;);
            pager.helper.addPartClasses(&#39;select-hidden&#39;, selectWrapper);
        }

<span id='Pager-method-constructor'><span id='Pager'>        /**
</span></span>         * 翻页控件
         *
         * 翻页控件包含2部分：
         *
         * - 一个显示页码的横条，根据各个属性配置显示当前页和前后若干页
         * - 一个选择“每页显示数量”的{@link Select}控件
         *
         * @extends Control
         * @requires Select
         * @constructor
         */
        function Pager(options) {
            Control.apply(this, arguments);
        }


<span id='Pager-static-cfg-defaultProperties'>        /**
</span>         * @cfg defaultProperties
         *
         * 默认属性值
         *
         * @cfg {number[]} [defaultProperties.pageSizes] 默认每页数量可选项
         * @cfg {number} [defaultProperties.pageSize=15] 默认每页数量
         * @static
         */
        Pager.defaultProperties = {
            // 这里不加任何属性，不然会覆盖掉实例上的那个`defaultProperties`出问题，
            // 如果使用者直接改这个，自然是要覆盖的就没关系
        };


        Pager.prototype = {
<span id='Pager-property-type'>            /**
</span>             * 控件类型，始终为`&quot;Pager&quot;`
             *
             * @type {string}
             * @readonly
             * @override
             */
            type: &#39;Pager&#39;,

<span id='Pager-property-defaultProperties'>            /**
</span>             * 默认属性
             *
             * @type {Object}
             * @deprecated 使用构造函数上的{@link Pager#cfg-defaultProperties}代替
             */
            defaultProperties: {
                pageSizes: [15, 30, 50, 100],
                pageSize: 15
            },

<span id='Pager-method-initOptions'>            /**
</span>             * 初始化参数
             *
             * @param {Object} [options] 构造函数传入的参数
             * @protected
             * @override
             */
            initOptions: function (options) {
                var properties = {
                    pageType: &#39;anchor&#39;,
                    count: 0,
                    page: 1,
                    backCount: 3,
                    forwardCount: 3,
                    backText: &#39;上一页&#39;,
                    forwardText: &#39;下一页&#39;,
                    urlTemplate: &#39;&#39;,
                    layout: &#39;alignLeft&#39;
                };

                u.extend(
                    properties,
                    this.defaultProperties, // 这么是向后兼容，以后准备去掉
                    Pager.defaultProperties,
                    options
                );
                this.setProperties(properties);
            },

<span id='Pager-method-initStructure'>            /**
</span>             * 初始化DOM结构
             *
             * @protected
             * @override
             */
            initStructure: function () {
                // 填充主元素代码
                this.main.innerHTML = getMainHTML(this);
                // 创建控件树
                this.helper.initChildren();

                // 当初始化pageSizes属性不存在或为空数组时，隐藏控件显示
                var select = this.getChild(&#39;select&#39;);
                if (!this.pageSizes || !this.pageSizes.length) {
                    hideSelect(this);
                }
                else {
                    var properties = {
                        datasource: getPageSizes(this.pageSizes),
                        value: this.pageSize + &#39;&#39;
                    };
                    select.setProperties(properties);
                }

                // 同步一次状态
                changePageSize.call(this);
            },

<span id='Pager-method-initEvents'>            /**
</span>             * 初始化事件交互
             *
             * @protected
             * @override
             */
            initEvents: function () {
                // 每页显示的select控件
                var select = this.getChild(&#39;select&#39;);
                select.on(&#39;change&#39;, changePageSize, this);

                // pager主元素绑定事件
                this.helper.addDOMEvent(&#39;main&#39;, &#39;click&#39;, pagerClick);
            },

<span id='Pager-method-setProperties'>            /**
</span>             * 批量设置控件的属性值
             *
             * @param {Object} properties 属性值集合
             * @override
             */
            setProperties: function (properties) {
                properties = u.clone(properties);

                // `pageIndex`提供从0开始的页码，但是以`page`为准
                if (properties.hasOwnProperty(&#39;pageIndex&#39;)
                    &amp;&amp; !properties.hasOwnProperty(&#39;page&#39;)
                ) {
<span id='Pager-property-pageIndex'>                    /**
</span>                     * @property {number} pageIndex
                     *
                     * 以0为起始的页码，其值始终为{@link Pager#page}减1
                     *
                     * 如果与{@link Pager#page}属性同时存在，
                     * 则优先使用{@link Pager#page}属性
                     */
                    properties.page = +properties.pageIndex + 1;
                }

                var digitalProperties = [
                    &#39;count&#39;, &#39;page&#39;, &#39;backCount&#39;,
                    &#39;forwardCount&#39;, &#39;pageSize&#39;
                ];

                u.each(
                    digitalProperties,
                    function (name) {
                        var value = properties[name];
                        if (u.isString(value)) {
                            properties[name] = +value;
                        }
                    }
                );

                var changes =
                    Control.prototype.setProperties.apply(this, arguments);

                if (changes.hasOwnProperty(&#39;page&#39;)) {
                    // 触发页码变更事件
<span id='Pager-event-changepage'>                    /**
</span>                     * @event changepage
                     *
                     * 页码变化时触发
                     *
                     * @member Pager
                     * @deprecated 使用{@link Pager#pagechange}代替
                     */
                    this.fire(&#39;changepage&#39;);

<span id='Pager-event-pagechange'>                    /**
</span>                     * @event pagechange
                     *
                     * 页码变化时触发
                     *
                     * @member Pager
                     */
                    this.fire(&#39;pagechange&#39;);
                }
            },

<span id='Pager-method-repaint'>            /**
</span>             * 重渲染
             *
             * @method
             * @protected
             * @override
             */
            repaint: require(&#39;./painters&#39;).createRepaint(
                Control.prototype.repaint,
                {
<span id='Pager-property-pageSizes'>                    /**
</span>                     * @property {number[]} pageSizes
                     *
                     * 可用的“每页条数”列表
                     */
                    name: &#39;pageSizes&#39;,
                    paint: function (pager, value) {
                        var select = pager.getChild(&#39;select&#39;);
                        // 当`pageSizes`属性不存在或为空数组时，隐藏控件显示
                        if (!value || !value.length) {
                            hideSelect(pager);
                        }
                        else {
                            var properties = {
                                datasource: getPageSizes(value),
                                value: pager.pageSize + &#39;&#39;
                            };
                            select.setProperties(properties);
                            showSelect(pager);
                        }
                    }
                },
                {
<span id='Pager-property-layout'>                    /**
</span>                     * @property {string} [layout=&quot;alignLeft&quot;]
                     *
                     * 指定控件的布局方式，可以使用以下值：
                     *
                     * - `alignLeft`：整体靠左对齐，页码在左，选择框在右
                     * - `alignLeftReversed`：整体靠左对齐，而码在右，选择框在左
                     * - `alignRight`：整体靠右对齐，页码在左，选择框在右
                     * - `alignRightReversed`：整体靠右对齐，而码在右，选择框在左
                     * - `distributed`：页码靠左对齐，选择框靠右对齐
                     * - `distributedReversed`：页码靠右对齐，选择框靠左对齐
                     */
                    name: &#39;layout&#39;,
                    paint: repaintLayout
                },
                {
                    name: [
<span id='Pager-property-pageType'>                        /**
</span>                         * @property {string} [pageType=&quot;anchor&quot;]
                         *
                         * 页码元素类型，可以为：
                         *
                         * - `plain`：页码为普通文本，点击后不跳转链接，
                         * 仅触发{@link Pager#pagechange}事件
                         * - `anchor`：页码为`&lt;a&gt;`元素，点击后直接跳转
                         */
                        &#39;pageType&#39;,

<span id='Pager-property-count'>                        /**
</span>                         * @property {number} [count=0]
                         *
                         * 总条目数量
                         */
                        &#39;count&#39;,

<span id='Pager-property-pageSize'>                        /**
</span>                         * @property {number} pageSize
                         *
                         * 每页显示条目数量
                         */
                        &#39;pageSize&#39;,

<span id='Pager-property-page'>                        /**
</span>                         * @property {number} [page=1]
                         *
                         * 当前页码，以1为起始，即1表示第1页
                         */
                        &#39;page&#39;,

<span id='Pager-property-backCount'>                        /**
</span>                         * @property {number} backCount
                         *
                         * 在当前页前面显示的页数
                         *
                         * 如{@link Pager#page}值为5，`backCount`为3，
                         * 则显示`[2] [3] [4]  [5]`
                         */
                        &#39;backCount&#39;,

<span id='Pager-property-forwardCount'>                        /**
</span>                         * @property {number} forwardCount
                         *
                         * 在当前页后面显示的页数
                         *
                         * 如{@link Pager#page}值为5，`forwardCount`为3，
                         * 则显示`[5] [6] [7] [8]`
                         */
                        &#39;forwardCount&#39;,

<span id='Pager-property-backText'>                        /**
</span>                         * @property {string} backText
                         *
                         * “下一页”元素的显示文字
                         */
                        &#39;backText&#39;,

<span id='Pager-property-forwardText'>                        /**
</span>                         * @property {string} forwardText
                         *
                         * “上一页”元素的显示文字
                         */
                        &#39;forwardText&#39;,

<span id='Pager-property-urlTemplate'>                        /**
</span>                         * @property {string} urlTemplate
                         *
                         * 用于生成链接地址的URL模板
                         *
                         * 模板中可以使用以下占位符：
                         *
                         * - `page`：当前页码
                         * - `pageSize`：每页显示条目数
                         */
                        &#39;urlTemplate&#39;
                    ],
                    paint: repaintPager
                }
            ),

<span id='Pager-method-getPageIndex'>            /**
</span>             * 获取从0开始的页码
             *
             * @return {number} 其值始终为{@link Pager#page}减去1
             */
            getPageIndex: function () {
                return this.get(&#39;page&#39;) - 1;
            }
        };

        lib.inherits(Pager, Control);
        ui.register(Pager);
        return Pager;
    }
);
</pre>
</body>
</html>
