<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='global-property-'>/**
</span> * ER (Enterprise RIA)
 * Copyright 2013 Baidu Inc. All rights reserved.
 *
 * @ignore
 * @file 视图类
 * @author otakustay
 */
define(
    function (require) {
        var util = require('./util');
        var u = require('underscore');

<span id='View-method-constructor'><span id='View'>        /**
</span></span>         * @class View
         *
         * 视图类
         *
         * 在ER框架中，View不一定要继承该类，
         * 任何有一个名为`render`的方法的对象均可作为View
         *
         * 该类结合`template`对象，实现了一个通用的RIA视图方案
         *
         * @extends mini-event.EventTarget
         * @constructor
         */
        var exports = {};

        exports.constructor = function () {

            // 如果prototype上的属性是引用类型，则复制一份，
            // 防止因共享修改导致的问题
            if (!this.hasOwnProperty('uiProperties') &amp;&amp; this.uiProperties) {
                this.uiProperties = u.clone(this.uiProperties);
            }

            if (!this.hasOwnProperty('uiEvents') &amp;&amp; this.uiEvents) {
                this.uiEvents = u.clone(this.uiEvents);
            }

            this.initialize();
        };

        exports.initialize = util.noop;

<span id='View-property-template'>        /**
</span>         * 对应的模板名，指定一个etpl的`target`来作为渲染的内容，
         * 具体参考[etpl的说明](https://github.com/ecomfe/etpl#target)
         */
        exports.template = '';

<span id='View-method-getTemplateName'>        /**
</span>         * 获取对应的模板名称，默认直接返回{@link View#template}属性
         *
         * @return {string}
         */
        exports.getTemplateName = function () {
            return this.template || '';
        };

<span id='View-property-model'>        /**
</span>         * 对应的{@link Model}对象，通常由{@link Action}设置
         *
         * @type {Mixed}
         * @readonly
         */
        exports.model = null;

<span id='View-property-container'>        /**
</span>         * 渲染容器的元素或其id，通常由{@link Action}设置
         *
         * @type {string | HTMLElement}
         * @readonly
         */
        exports.container = '';

<span id='View-method-getContainerElement'>        /**
</span>         * 获取渲染容器的元素，默认返回{@link View#container}指定的元素
         *
         * @return {HTMLElement}
         */
        exports.getContainerElement = function () {
            return util.getElement(this.container) || null;
        };

<span id='View-method-getTemplateData'>        /**
</span>         * 获取用于模板渲染的数据对象
         *
         * @return {Object}
         */
        exports.getTemplateData = function () {
            var model = this.model;
            if (model &amp;&amp; typeof model.get !== 'function') {
                var Model = require('./Model');
                model = new Model(model);
            }

            var visit = function (propertyPath) {
                var path = propertyPath.replace(/\[(\d+)\]/g, '.$1').split('.');
                var propertyName = path.shift();
                var value = model.get(propertyName);

                while (value &amp;&amp; (propertyName = path.shift())) {
                    value = value[propertyName];
                }

                return value;
            };

            return {get: visit, relatedModel: model};
        };

<span id='View-method-render'>        /**
</span>         * 渲染当前视图
         *
         * ER的默认实现是使用[etpl](https://github.com/ecomfe/etpl)渲染容器，
         * 如果需要使用其它的模板，或自己有视图的管理，建议重写此方法
         */
        exports.render = function () {
            var container = this.getContainerElement();
            // 容器没有还不一定是没配置好，很可能是主Action销毁了子Action才刚加载完
            if (!container) {
                var url = this.model
                    &amp;&amp; typeof this.model.get === 'function'
                    &amp;&amp; this.model.get('url');
                throw new Error('Container not found when rendering ' + (url ? '&quot;' + url + '&quot;' : 'view'));
            }

            var template = require('etpl');
            var html = template.render(this.getTemplateName(), this.getTemplateData());
            container.innerHTML = html;

            this.enterDocument();
        };


<span id='View-property-enterDocument'>        /**
</span>         * 当容器渲染完毕后触发，用于控制元素可见性及绑定事件等DOM操作
         *
         * @protected
         */
        exports.enterDocument = require('./util').noop;

<span id='View-method-dispose'>        /**
</span>         * 销毁当前视图
         */
        exports.dispose = function () {
            var container = this.getContainerElement();
            container &amp;&amp; (container.innerHTML = '');
        };

        var View = require('./inheritEventTarget')(exports);
        return View;
    }
);
</pre>
</body>
</html>
